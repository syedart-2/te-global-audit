<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Towards Eternity Global Growth Audit</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser for AI Comments -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        .stat-value { font-size: 1.875rem; font-weight: 700; color: #f8fafc; }
        .stat-label { font-size: 0.875rem; color: #94a3b8; }
        .badge-red { background-color: #7f1d1d; color: #fca5a5; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background-color: #14532d; color: #86efac; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-yellow { background-color: #713f12; color: #fde047; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        
        .ai-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .grade-circle {
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 800;
            border: 4px solid;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="p-6">

    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b border-gray-700 pb-6">
        <div>
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                Towards Eternity Global Growth Audit
            </h1>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2">
                <p class="text-gray-400">Senior Full-Stack Growth Analysis ‚Ä¢ Dynamic Report</p>
                <span class="hidden sm:inline text-gray-600">|</span>
                <div id="auditPeriod" class="text-xs font-mono text-emerald-400 bg-emerald-900/20 px-2 py-1 rounded hidden">
                    <!-- Populated by JS -->
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-1 font-mono">Designed by Muhammad Ali Nasir ud Din</p>
        </div>
        <div class="mt-4 md:mt-0 flex gap-4 items-center">
            <!-- AI Trigger Button (Hidden until data loaded) -->
            <button id="aiTriggerBtn" onclick="runAIAnalysis()" class="hidden bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition shadow-lg ai-pulse">
                <i data-lucide="sparkles"></i> Analyze Data with AI
            </button>

            <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('csvInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                <i data-lucide="upload"></i> Upload CSV
            </button>
            <button onclick="loadDemoData()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition text-xs">
                Load Demo Data
            </button>
        </div>
    </header>

    <!-- EMPTY STATE (Visible on Load) -->
    <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-center space-y-4">
        <div class="bg-gray-800 p-6 rounded-full">
            <i data-lucide="upload-cloud" class="w-16 h-16 text-blue-500"></i>
        </div>
        <h2 class="text-2xl font-bold text-white">Ready to Audit</h2>
        <p class="text-gray-400 max-w-md">Please upload a CSV file containing your social media post data (Account, Reach, Shares, Likes, Comments, Type, Date).</p>
        <button onclick="document.getElementById('csvInput').click()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            Select CSV File
        </button>
    </div>

    <!-- MAIN DASHBOARD GRID (Hidden on Load) -->
    <div id="dashboardGrid" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- SECTION: Account Health Scorecard -->
        <div class="lg:col-span-12 card bg-gradient-to-r from-slate-900 to-slate-800 border-slate-700">
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="flex-shrink-0 text-center">
                    <h2 class="text-sm font-bold text-gray-400 mb-2">ACCOUNT HEALTH GRADE</h2>
                    <div id="healthGradeCircle" class="grade-circle bg-gray-800 text-gray-500 border-gray-600 mx-auto">
                        -
                    </div>
                </div>
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                        <i data-lucide="activity" class="text-emerald-400"></i> Performance Summary
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                        <div class="bg-slate-800/50 p-2 rounded">
                            <div class="text-xs text-gray-400">Avg Share Rate</div>
                            <div id="scoreShare" class="text-lg font-bold text-white">-</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded">
                            <div class="text-xs text-gray-400">Avg Conv. Rate</div>
                            <div id="scoreConv" class="text-lg font-bold text-white">-</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded">
                            <div class="text-xs text-gray-400">Top Account</div>
                            <div id="scoreTop" class="text-lg font-bold text-emerald-400 break-words text-sm leading-tight">-</div>
                        </div>
                         <div class="bg-slate-800/50 p-2 rounded">
                            <div class="text-xs text-gray-400">Total Posts Audit</div>
                            <div id="scoreCount" class="text-lg font-bold text-blue-400">-</div>
                        </div>
                    </div>
                    <!-- AI Insight Box -->
                    <div id="scorecardInsight" class="hidden mt-2 p-3 bg-indigo-900/20 border border-indigo-500/30 rounded text-sm text-indigo-200">
                         <div class="flex items-center gap-2 mb-1 text-indigo-400 font-bold text-xs uppercase">
                            <i data-lucide="bot" class="w-3 h-3"></i> AI Strategic Review
                        </div>
                        <div class="ai-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: Growth & Reach Analysis -->
        <div class="lg:col-span-12 card">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="eye" class="text-cyan-400"></i> Growth & Reach Analysis
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Stats -->
                <div class="space-y-4">
                    <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                        <div class="text-gray-400 text-sm">Total Cumulative Reach</div>
                        <div id="totalReachDisplay" class="text-2xl font-bold text-white">-</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                            <div class="text-gray-400 text-xs">Followers Gained</div>
                            <div id="totalFollowsDisplay" class="text-xl font-bold text-green-400">-</div>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                            <div class="text-gray-400 text-xs">Unfollows</div>
                            <div id="totalUnfollowsDisplay" class="text-xl font-bold text-red-400">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Doughnut Chart -->
                <div class="md:col-span-2 h-64 relative">
                    <canvas id="visibilityChart"></canvas>
                </div>
            </div>
            <!-- AI Insight Box -->
            <div id="visibilityInsight" class="hidden mt-4 p-3 bg-cyan-900/20 border border-cyan-500/30 rounded text-sm text-cyan-200">
                <div class="flex items-center gap-2 mb-1 text-cyan-400 font-bold text-xs uppercase">
                    <i data-lucide="bot" class="w-3 h-3"></i> AI Visibility Analysis
                </div>
                <div class="ai-content"></div>
            </div>
        </div>

        <!-- SECTION: Content Format ROI -->
        <div class="lg:col-span-12 card bg-[#162032] border border-gray-700">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="layers" class="text-fuchsia-400"></i> Content Format ROI
                </h2>
                <select id="formatAccountSelect" onchange="renderFormatAnalysisFromGlobal()" class="mt-2 sm:mt-0 bg-gray-800 border border-gray-600 text-xs text-white rounded px-3 py-2 focus:outline-none focus:border-fuchsia-500">
                    <option value="all">All Accounts Aggregated</option>
                    <!-- Populated by JS -->
                </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Format: Images -->
                <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-blue-500 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="image" class="w-16 h-16 text-blue-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-blue-200 mb-4">Images</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Likes</span>
                            <span class="text-white font-mono" id="imgLikes">-</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Shares</span>
                            <span class="text-white font-mono" id="imgShares">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400 text-sm">Comments</span>
                            <span class="text-white font-mono" id="imgComments">-</span>
                        </div>
                    </div>
                </div>

                <!-- Format: Carousels -->
                <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-yellow-500 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="copy" class="w-16 h-16 text-yellow-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-yellow-200 mb-4">Carousels</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Likes</span>
                            <span class="text-white font-mono" id="carLikes">-</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Shares</span>
                            <span class="text-white font-mono" id="carShares">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400 text-sm">Comments</span>
                            <span class="text-white font-mono" id="carComments">-</span>
                        </div>
                    </div>
                </div>

                <!-- Format: Reels/Shorts -->
                <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-fuchsia-500 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="play-circle" class="w-16 h-16 text-fuchsia-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-fuchsia-200 mb-4">Reels / Shorts</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Likes</span>
                            <span class="text-white font-mono" id="vidLikes">-</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-700 pb-2">
                            <span class="text-gray-400 text-sm">Shares</span>
                            <span class="text-white font-mono" id="vidShares">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400 text-sm">Comments</span>
                            <span class="text-white font-mono" id="vidComments">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- AI Insight Box -->
            <div id="formatInsight" class="hidden mt-4 p-3 bg-fuchsia-900/20 border border-fuchsia-500/30 rounded text-sm text-fuchsia-200">
                <div class="flex items-center gap-2 mb-1 text-fuchsia-400 font-bold text-xs uppercase">
                    <i data-lucide="bot" class="w-3 h-3"></i> AI Format Strategy
                </div>
                <div class="ai-content"></div>
            </div>
        </div>

        <!-- SECTION 1: Performance Deep Dive (Chart) -->
        <div class="lg:col-span-8 card relative">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="text-blue-400"></i> Reach vs. Share Rate
                </h2>
                <div class="text-xs text-gray-500">Sorted by Conversion Efficiency</div>
            </div>
            <div class="relative h-80 w-full mb-4">
                <canvas id="performanceChart"></canvas>
            </div>
            <!-- AI Insight Box -->
            <div id="performanceInsight" class="hidden p-3 bg-blue-900/20 border border-blue-500/30 rounded text-sm text-blue-200">
                <div class="flex items-center gap-2 mb-1 text-blue-400 font-bold text-xs uppercase">
                    <i data-lucide="bot" class="w-3 h-3"></i> AI Performance Analysis
                </div>
                <div class="ai-content"></div>
            </div>
        </div>

        <!-- SECTION 1B: Conversion Efficiency Table -->
        <div class="lg:col-span-4 card overflow-hidden flex flex-col">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="trending-up" class="text-emerald-400"></i> Follower Conversion
            </h2>
            <div class="overflow-y-auto flex-1 mb-2">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="pb-2">Account/Lang</th>
                            <th class="pb-2 text-right">Conv. Rate</th>
                            <th class="pb-2 text-right">Status</th>
                        </tr>
                    </thead>
                    <tbody id="conversionTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
             <!-- AI Insight Box -->
             <div id="conversionInsight" class="hidden p-3 bg-emerald-900/20 border border-emerald-500/30 rounded text-sm text-emerald-200 mt-auto">
                <div class="flex items-center gap-2 mb-1 text-emerald-400 font-bold text-xs uppercase">
                   <i data-lucide="bot" class="w-3 h-3"></i> AI Growth Analysis
               </div>
               <div class="ai-content"></div>
           </div>
        </div>

        <!-- SECTION 2: Regional Timing Audit -->
        <div class="lg:col-span-6 card">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="globe" class="text-orange-400"></i> Regional Timing Intelligence
            </h2>
            <div class="flex justify-between items-end mb-4 border-b border-gray-700 pb-2">
                <div>
                    <p class="text-sm text-gray-400">Average Behavior vs. Golden Hours (AI-Updated)</p>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-500">Poster Location:</span>
                    <div class="text-sm font-bold text-indigo-400">Istanbul (UTC+3)</div>
                </div>
            </div>
            
            <div id="timingContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2 mb-4">
                <!-- Timing Cards Populated by JS -->
            </div>

             <!-- AI Insight Box -->
             <div id="timingInsight" class="bg-orange-900/20 border border-orange-800 rounded p-3 text-sm text-orange-200 hidden">
                <div class="flex items-center gap-2 mb-1 text-orange-400 font-bold text-xs uppercase">
                    <i data-lucide="bot" class="w-3 h-3"></i> AI Schedule Optimization
                </div>
                <div class="ai-content"></div>
            </div>
        </div>

        <!-- SECTION 3: Title & Hook Audit -->
        <div class="lg:col-span-6 card">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="type" class="text-purple-400"></i> Title & Hook Intelligence
            </h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-gray-400 text-xs uppercase tracking-wide">Strong Hooks</div>
                    <div id="strongHooksCount" class="text-2xl font-bold text-emerald-400">0</div>
                </div>
                <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="text-gray-400 text-xs uppercase tracking-wide">Weak Hooks</div>
                    <div id="weakHooksCount" class="text-2xl font-bold text-red-400">0</div>
                </div>
            </div>

            <!-- AI Insight Box -->
            <div id="hookInsight" class="hidden mb-4 p-3 bg-purple-900/20 border border-purple-500/30 rounded text-sm text-purple-200">
                <div class="flex items-center gap-2 mb-1 text-purple-400 font-bold text-xs uppercase">
                   <i data-lucide="bot" class="w-3 h-3"></i> AI Copywriting Critique
               </div>
               <div class="ai-content"></div>
           </div>

            <h3 class="font-semibold text-white mb-2 text-sm">Viral Template Generator</h3>
            <div class="space-y-2">
                <div class="p-3 bg-gray-900 rounded border border-gray-700 text-sm text-gray-300 cursor-pointer hover:border-blue-500 transition" onclick="copyText(this)">
                    "The secret to [Benefit] without [Pain Point]..."
                </div>
                <div class="p-3 bg-gray-900 rounded border border-gray-700 text-sm text-gray-300 cursor-pointer hover:border-blue-500 transition" onclick="copyText(this)">
                    "Stop doing [Common Mistake] if you want [Result]..."
                </div>
            </div>
        </div>

        <!-- SECTION: AI Content Assistant Tool (NEW) -->
        <div class="lg:col-span-12 card bg-slate-900 border border-teal-500/30">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="sparkles" class="text-teal-400"></i> AI Content Assistant
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Target Account/Language</label>
                        <select id="assistantLangSelect" class="w-full bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 text-sm focus:border-teal-500 focus:outline-none">
                            <option value="English">English</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Content Details (Topic, Type)</label>
                        <textarea id="assistantContext" class="w-full bg-gray-800 border border-gray-600 text-white rounded px-3 py-2 text-sm focus:border-teal-500 focus:outline-none h-24" placeholder="e.g. A motivational reel about patience in hard times..."></textarea>
                    </div>
                    <button onclick="generateSpecificSuggestions()" id="btnGenerateAssistant" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                        <i data-lucide="wand-2" class="w-4 h-4"></i> Get Suggestions
                    </button>
                </div>
                <div class="md:col-span-2 bg-gray-950/50 rounded border border-gray-800 p-4 relative">
                    <div id="assistantOutput" class="text-sm text-gray-300 leading-relaxed min-h-[150px]">
                        <span class="text-gray-600 italic">AI suggestions for titles and hashtags will appear here...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 4: Hashtag Audit -->
        <div class="lg:col-span-12 card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="hash" class="text-pink-400"></i> Islamic Hashtag Strategy
                    </h2>
                    <p class="text-xs text-gray-500 mt-1">SEO Recommendations tailored for Islamic Content (AI-Updated)</p>
                </div>
                
                <!-- Platform Toggle -->
                <div class="flex bg-gray-800 rounded-lg p-1 mt-3 md:mt-0">
                    <button onclick="togglePlatform('instagram')" id="btn-instagram" class="px-4 py-2 rounded text-sm font-medium transition bg-pink-600 text-white shadow-lg">
                        Instagram
                    </button>
                    <button onclick="togglePlatform('facebook')" id="btn-facebook" class="px-4 py-2 rounded text-sm font-medium transition text-gray-400 hover:text-white">
                        Facebook
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- Global Tags -->
                <div class="md:col-span-5">
                    <h3 class="text-sm font-semibold text-blue-300 mb-3 border-b border-blue-900/50 pb-2">Global (English)</h3>
                    <div id="globalTagsContainer" class="flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Native Tags -->
                <div class="md:col-span-7">
                    <div class="flex justify-between items-center mb-3 border-b border-emerald-900/50 pb-2">
                         <h3 class="text-sm font-semibold text-emerald-300">Native Tags</h3>
                         <select id="languageSelect" onchange="renderNativeTags()" class="bg-gray-800 border border-gray-600 text-xs text-white rounded px-2 py-1 focus:outline-none focus:border-emerald-500 w-1/2">
                             <option value="">Select Account</option>
                         </select>
                    </div>
                   
                    <div id="nativeTagsContainer" class="bg-gray-800/50 p-4 rounded border border-gray-700 min-h-[100px]">
                        <!-- Populated by JS based on Dropdown -->
                        <div class="text-gray-500 text-xs text-center italic mt-4">Select an account from the list above.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 5: Roadmap -->
        <div class="lg:col-span-12 card bg-gradient-to-br from-gray-900 to-gray-800 border-blue-900/30">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <i data-lucide="map" class="text-yellow-400"></i> Senior Engineer's Roadmap
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- The Content Bridge -->
                <div class="col-span-1 md:col-span-1 space-y-4">
                    <h3 class="text-lg font-semibold text-blue-200">The Content Bridge Strategy</h3>
                    <div class="p-4 bg-gray-900/50 border border-blue-500/20 rounded-lg">
                        <h4 class="text-sm font-bold text-blue-400 mb-2">From Leader to Laggards</h4>
                        <div id="contentBridgeText" class="text-sm text-gray-300 leading-relaxed mb-3">
                            <!-- Dynamic Text inserted by JS -->
                            <span class="text-gray-500 italic">Data required...</span>
                        </div>
                        <ul class="text-xs text-gray-400 space-y-2 list-disc list-inside">
                            <li><strong>Action 1:</strong> Lower performing accounts must shift posting time to match the leader's window.</li>
                            <li><strong>Action 2:</strong> Replicate the "Question-First" structure from top performing titles.</li>
                        </ul>
                    </div>
                </div>

                <!-- Immediate Fixes -->
                <div class="col-span-1 md:col-span-2">
                    <h3 class="text-lg font-semibold text-blue-200 mb-4">Immediate Fixes (Auto-Generated)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="fixesContainer">
                        <!-- Fixes populated via JS -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CONFIG & DATA ---
        // SECURITY NOTE: In a real production app, never expose API keys in client-side code.
        const GEMINI_API_KEY = ""; 

        let chartInstance = null;
        let visibilityChartInstance = null;
        let currentPlatform = 'instagram'; // 'instagram' or 'facebook'
        let currentProcessedData = []; // Store data globally
        let currentRawData = [];

        // Helper: Robust Safe Parse for various number formats
        const safeParse = (val) => {
            if (val === null || val === undefined) return 0;
            if (typeof val === 'number') return Math.round(val);
            
            let str = val.toString().trim().toUpperCase();
            if (str === '') return 0;
            
            // 1. Detect Suffixes (Standard US or Custom)
            let multiplier = 1;
            if (str.endsWith('K')) multiplier = 1000;
            else if (str.endsWith('M')) multiplier = 1000000;
            else if (str.endsWith('B')) multiplier = 1000000000;
            
            // Remove suffixes for cleaning
            str = str.replace(/[KMB]/g, '').trim();
            
            if (multiplier > 1) {
                // Suffix Handling (e.g. 1.5K -> 1500)
                str = str.replace(',', '.'); // Standardize decimal
                const clean = str.replace(/[^0-9.-]/g, '');
                const num = parseFloat(clean);
                return isNaN(num) ? 0 : Math.round(num * multiplier);
            } else {
                // NO SUFFIX -> STRICT INTEGER (e.g. 1.000 or 1,000 or 1 000 -> 1000)
                // Remove EVERYTHING that isn't a digit
                const clean = str.replace(/[^0-9]/g, '');
                const num = parseInt(clean, 10);
                return isNaN(num) ? 0 : num;
            }
        };

        // Mock Data
        const demoData = [
            { language: "Uzbek", type: "Reel", likes: 200, comments: 45, reach: 85000, shares: 1200, follows: 850, unfollows: 10, postingTime: "2023-10-01 16:00", description: "Wait for the end! üò± #viral", hasHashtags: true },
            { language: "Persian", type: "Image", likes: 150, comments: 20, reach: 72000, shares: 950, follows: 710, unfollows: 5, postingTime: "2023-10-02 17:30", description: "The truth about success.", hasHashtags: true },
            { language: "Spanish", type: "Carousel", likes: 300, comments: 60, reach: 65000, shares: 800, follows: 500, unfollows: 20, postingTime: "2023-10-03 20:00", description: "¬øSab√≠as esto? #curioso", hasHashtags: true },
            { language: "Hindi", type: "Video", likes: 100, comments: 10, reach: 55000, shares: 600, follows: 450, unfollows: 0, postingTime: "2023-10-04 10:00", description: "Amazing facts for you", hasHashtags: false },
            { language: "Urdu", type: "Image", likes: 90, comments: 5, reach: 50000, shares: 550, follows: 400, unfollows: 5, postingTime: "2023-10-05 15:00", description: "Beautiful poetry", hasHashtags: true },
            { language: "Arabic", type: "Reel", likes: 120, comments: 15, reach: 48000, shares: 400, follows: 300, unfollows: 2, postingTime: "2023-10-06 14:00", description: "Daily reminder.", hasHashtags: false },
            { language: "Russian", type: "Carousel", likes: 80, comments: 8, reach: 42000, shares: 350, follows: 250, unfollows: 1, postingTime: "2023-10-07 18:00", description: "Check this out", hasHashtags: true },
            { language: "Bengali", type: "Image", likes: 50, comments: 2, reach: 30000, shares: 200, follows: 150, unfollows: 0, postingTime: "2023-10-08 09:00", description: "Good morning", hasHashtags: true },
        ];

        // TIMEZONE DATABASE
        const timezoneOffsets = {
            "Uzbek": 2, "Uzbekistan": 2, 
            "Persian": 0.5, "Farsi": 0.5, 
            "Indonesian": 4, "Indonesia": 4, "Bahasa": 4,
            "Hindi": 2.5, "India": 2.5, 
            "Urdu": 2, "Pakistan": 2, 
            "Bengali": 3, "Bangladesh": 3, "Bangla": 3, 
            "Russian": 0, "Russia": 0, 
            "Arabic": 0, "Arab": 0, "Saudi": 0, 
            "Turkish": 0, "Turkey": 0, 
            "German": -2, "Germany": -2, "Deutsch": -2, "Germen": -2,
            "French": -2, "France": -2, 
            "Spanish": -2, "Spain": -2, "Espanol": -2, 
            "English": -3, "UK": -3, 
            "Portuguese": -2, "Brazil": -6 
        };

        // DEFAULT BEST TIMES (Can be updated by AI)
        let bestTimesDB = {
            "Uzbek": 19, "Persian": 20, "Indonesian": 18, "Hindi": 18, "Urdu": 19, "Russian": 18,
            "Arabic": 21, "Turkish": 20, "German": 18, "Germen": 18, "French": 18, "Spanish": 21, 
            "English": 19, "Portuguese": 19, "Bengali": 19, "Bangla": 19, "Urdu-Hindi": 19
        };

        // HASHTAG DATABASE (Can be updated by AI)
        let islamicHashtagsDB = {
            instagram: {
                global: ["#Islam", "#Muslim", "#Quran", "#Allah", "#ProphetMuhammad", "#IslamicQuotes", "#Deen", "#Sunnah", "#MuslimUmmah", "#IslamicReminder", "#Fajr", "#Dawah", "#Hijab", "#Halal"],
                native: {
                    "Arabic": ["#ÿßÿ≥ŸÑÿßŸÖ", "#ŸÇÿ±ÿ¢ŸÜ", "#ÿßŸÑŸÑŸá", "#ÿØÿπÿßÿ°", "#ŸÖÿ≥ŸÑŸÖ", "#ÿ≠ÿØŸäÿ´", "#ÿ™ŸÑÿßŸàÿ©", "#ÿßŸÑÿ¨ŸÜÿ©", "#ÿßÿ∞ŸÉÿßÿ±", "#ÿßŸÑÿ±ÿ≥ŸàŸÑ"],
                    "Urdu": ["#ÿßÿ≥ŸÑÿßŸÖ", "#ŸÇÿ±ÿ¢ŸÜ", "#ÿ≠ÿØŸäÿ´", "#ŸÜÿπÿ™", "#ÿØ€åŸÜ", "#ŸÖÿ≥ŸÑŸÖÿßŸÜ", "#ÿßŸÑŸÑ€Å", "#ŸÜÿ®€å", "#ÿØÿπÿß", "#ÿ®€åÿßŸÜ"],
                    "Urdu-Hindi": ["#IslamPakistan", "#UrduDeen", "#PakistanZindabad", "#IslamicReminderUrdu", "#SunnahPakistan", "#DeenEIslam", "#UrduDawah", "#IslamInPakistan", "#TowardsEternityUrdu", "#ÿßÿ±ÿØŸà", "#ÿßÿ≥ŸÑÿßŸÖ", "#Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ", "#ÿØ€åŸÜ", "#ÿ≥ŸÜÿ™"],
                    "Turkish": ["#ƒ∞slam", "#Kuran", "#Allah", "#M√ºsl√ºman", "#Dua", "#Namaz", "#Ayet", "#Hadis", "#Peygamber", "#ƒ∞lim"],
                    "Indonesian": ["#Islam", "#Hijrah", "#Dakwah", "#Muslim", "#AlQuran", "#Doa", "#Sholat", "#KajianIslam", "#Sunnah", "#Inspirasi"],
                    "Persian": ["#ÿßÿ≥ŸÑÿßŸÖ", "#ŸÇÿ±ÿ¢ŸÜ", "#ÿÆÿØÿß", "#ŸÜŸÖÿßÿ≤", "#Ÿæ€åÿßŸÖÿ®ÿ±", "#ÿØ€åŸÜ", "#ŸÖÿ∞Ÿáÿ®€å", "#ÿØÿπÿß", "#ÿµŸÑŸàÿßÿ™", "#ÿ®ŸÜÿØ⁄Ø€å"],
                    "Russian": ["#–ò—Å–ª–∞ÿßŸÖ", "#–ö–æ—Ä–∞–Ω", "#–ê–ª–ª–∞—Ö", "#–ú—É—Å—É–ª—å–º–∞–Ω–µ", "#–ù–∞–º–∞–∑", "#–°—É–Ω–Ω–∞", "#–†–µ–ª–∏–≥–∏—è", "#–î—É–∞", "#–ú–µ—á–µ—Ç—å"],
                    "German": ["#Islam", "#Muslim", "#Koran", "#Allah", "#Gebet", "#Dua", "#Sunnah", "#Religion", "#Deutsch"],
                    "French": ["#Islam", "#Coran", "#Allah", "#Rappel", "#Musulman", "#Pri√®re", "#Dine", "#Sounnah", "#Mosqu√©e"],
                    "Spanish": ["#Islam", "#Coran", "#Allah", "#Musulmanes", "#Dios", "#Religion", "#LatinoMuslim", "#Dawah"],
                    "Uzbek": ["#Islom", "#Alloh", "#Quron", "#Namoz", "#Duo", "#Muslim", "#Hadis", "#Iymon", "#Juma"],
                    "Bengali": ["#‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ", "#‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®", "#‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú", "#‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π", "#‡¶π‡¶æ‡¶¶‡¶ø‡¶∏", "#‡¶Æ‡ßÅ‡¶∏‡¶≤‡¶ø‡¶Æ", "#‡¶¶‡ßã‡ßü‡¶æ", "#‡¶∏‡ßÅ‡¶®‡ßç‡¶®‡¶æ‡¶π"],
                    "Hindi": ["#Islam", "#Quran", "#Allah", "#Deen", "#Muslim", "#Ibadat", "#Dua", "#Sunnat"]
                }
            },
            facebook: {
                global: ["#Islam", "#Muslims", "#QuranVerses", "#IslamicPost", "#IslamicKnowledge", "#DailyIslamicReminder", "#LoveIslam", "#IslamicPage", "#MuslimLife"],
                native: {
                    "Arabic": ["#ÿßÿ≥ŸÑÿßŸÖŸäÿßÿ™", "#ÿßÿØÿπŸäÿ©", "#ÿ∞ŸÉÿ±_ÿßŸÑŸÑŸá", "#ŸÖŸàÿπÿ∏ÿ©", "#ÿßŸäÿßÿ™_ŸÇÿ±ÿßŸÜŸäÿ©", "#ÿ±ÿ≥ÿßÿ¶ŸÑ_ÿØŸäŸÜŸäÿ©"],
                    "Urdu": ["#ÿßÿ≥ŸÑÿßŸÖ€å_Ÿæ€åÿ∫ÿßŸÖ", "#ÿØ€åŸÜ€å_ŸÖÿπŸÑŸàŸÖÿßÿ™", "#ÿßŸÇŸàÿßŸÑ_ÿ≤ÿ±€å⁄∫", "#ŸÇÿ±ÿ¢ŸÜ€å_ÿ¢€åÿßÿ™", "#ŸÖÿ≥ÿ¶ŸÑ€Å"],
                    "Urdu-Hindi": ["#IslamPakistan", "#IslamicPostUrdu", "#UrduDeen", "#PakistanMuslims", "#IslamicValuesPakistan", "#SunnahUrdu", "#TowardsEternityUrdu", "#ÿßÿ≥ŸÑÿßŸÖ€å_Ÿæ€åÿ∫ÿßŸÖ", "#ÿØ€åŸÜ€å_ŸÖÿπŸÑŸàŸÖÿßÿ™", "#Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ"],
                    "Turkish": ["#DiniS√∂zler", "#ƒ∞slamiPayla≈üƒ±m", "#Ayetler", "#Dualar", "#M√ºmin"],
                    "Indonesian": ["#DakwahIslam", "#MotivasiIslam", "#Ceramah", "#Kutipanislam", "#DuniaIslam"],
                    "Persian": ["#ŸÖÿ∑ÿßŸÑÿ®_ŸÖÿ∞Ÿáÿ®€å", "#ÿ≥ÿÆŸÜÿ±ÿßŸÜ€å", "#ÿßÿ≠ÿßÿØ€åÿ´", "#ŸÜ⁄©ÿßÿ™_ŸÇÿ±ÿ¢ŸÜ€å", "#ÿÆÿØÿßŸàŸÜÿØ", "#ŸÇÿ±ÿßÿ¶ÿ™"],
                    "Russian": ["#–ò—Å–ª–∞–º—Å–∫–∏–µ–ö–∞—Ä—Ç–∏–Ω–∫–∏", "#–ò—Å–ª–∞–º–í–∏–¥–µ–æ", "#–ò—Å—Ç–∏–Ω–∞"],
                    "German": ["#IslamDeutschland", "#Wissen", "#Glaube"],
                    "French": ["#RappelIslam", "#Sagesse", "#Spiritualit√©"],
                    "Spanish": ["#IslamEnEspa√±ol", "#Sabiduria", "#Fe"],
                    "Uzbek": ["#IslomiyVideo", "#Maruzalar", "#Hikmatlar"],
                    "Bengali": ["#‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï_‡¶™‡ßãÿ≥ÿ™", "#‡¶¶‡ßç‡¶¨‡ßÄŸÜ€å_‡¶ï‡¶•‡¶æ", "#‡¶ì‡ßü‡¶æ‡¶ú"],
                    "Hindi": ["#IslamKiBaat", "#DeeniMalumat", "#QuranAurHadees"]
                }
            }
        };

        // NEW: Prioritized Account/Language list to prevent specific mix-ups
        const languageAliasesPriority = [
            { canonical: "Urdu-Hindi", aliases: ["towardseternityurdu_", "towardseternityurdu", "ÿßÿ±ÿØŸà ‡§π‡§ø‡§Ç‡§¶‡•Ä", "urdu hindi"] },
            { canonical: "Hindi", aliases: ["towards eternity hindi", "hindi account", "hindi"] },
            { canonical: "Urdu", aliases: ["towards eternity urdu", "urdu account", "urdu"] },
            { canonical: "Uzbek", aliases: ["Uzbek", "Uzbekistan", "O'zbek", "O ªzbek"] },
            { canonical: "Persian", aliases: ["Persian", "Farsi", "Iran", "ŸÅÿßÿ±ÿ≥€å"] },
            { canonical: "Indonesian", aliases: ["Indonesian", "Indonesia", "Bahasa", "Indo"] },
            { canonical: "Arabic", aliases: ["Arabic", "Arab", "Saudi", "Middle East", "Araby", "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", "ÿπÿ±ÿ®Ÿä"] },
            { canonical: "Turkish", aliases: ["Turkish", "Turkey", "T√ºrk√ße"] },
            { canonical: "Russian", aliases: ["Russian", "Russia", "–†—É—Å—Å–∫–∏–π"] },
            { canonical: "German", aliases: ["German", "Germany", "Deutsch", "Germen"] },
            { canonical: "French", aliases: ["French", "France", "Fran√ßais"] },
            { canonical: "Spanish", aliases: ["Spanish", "Spain", "Espanol", "Latino", "Espa√±ol"] },
            { canonical: "Bengali", aliases: ["Bengali", "Bangladesh", "Bangla", "‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ"] }
        ];

        // RESTORED: Specific Fixes Database to avoid ReferenceError
        const specificFixesDB = {
            "Uzbek": "Scale volume. Increase from 1/day to 2/day.",
            "Persian": "Test carousel format to increase dwell time.",
            "Spanish": "Improve hook clarity in first 3 seconds.",
            "Hindi": "Add English subtitles for broader reach.",
            "Urdu": "Use trending audio tracks.",
            "Arabic": "Shift posting time to 20:00 (Evening peak).",
            "Russian": "Engage in comments within first hour.",
            "Bengali": "Use higher contrast thumbnails.",
            "French": "CRITICAL: Stop posting at 3AM. Move to 18:00.",
            "Indonesian": "Rewrite titles. 'Update' is not a hook.",
            "German": "Use hashtags. Add #Lernen #Wissen."
        };

        // --- 2. AI LOGIC ---
        
        async function runAIAnalysis() {
            const btn = document.getElementById('aiTriggerBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> Analyzing...`;
            btn.disabled = true;

            // Prepare Context
            const accountSummary = currentProcessedData.slice(0, 20).map(d => `${d.language} (Reach:${d.reach})`).join(', ');
            const sampleTitles = currentRawData.slice(0, 5).map(r => r.description).join(' | ');
            const langsToAnalyze = languageAliasesPriority.map(l => l.canonical); 
            
            const prompt = `
            Act as a Senior Social Media Strategist for "Towards Eternity", a global Islamic brand.
            Analyze this data: ${accountSummary}. 
            Sample Titles: ${sampleTitles}.

            Tasks:
            1. Update "Golden Hour" (Best posting time, 24h int, Local Time) for: ${langsToAnalyze.join(', ')}.
            2. Generate 10 TRENDING, NEUTRAL, ISLAMIC hashtags in native script for each language.
            3. "conversionComment": Analyze Follower Conversion. (2 sentences).
            4. "hookComment": Critique the sample titles provided. (2 sentences).
            5. "timingComment": Analyze the scheduling. (2 sentences).
            6. "scorecardComment": Overall strategic health assessment. (2 sentences).
            7. "visibilityInsight": Analyze reach/views distribution. Why is the top account winning? (2 sentences).
            8. "formatInsight": Analyze content formats (Reels vs Images). Which is performing best and why? (2 sentences).
            9. "performanceInsight": Comment on the Reach vs Share Rate chart. (2 sentences).

            Return ONLY valid JSON:
            {
                "bestTimes": { "Arabic": 22, ... },
                "hashtags": { "Arabic": ["#tag1", ...], ... },
                "conversionComment": "...",
                "hookComment": "...",
                "timingComment": "...",
                "scorecardComment": "...",
                "visibilityInsight": "...",
                "formatInsight": "...",
                "performanceInsight": "..."
            }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const textResponse = data.candidates[0].content.parts[0].text;
                
                const jsonStr = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiResult = JSON.parse(jsonStr);

                // Apply Updates
                updateDatabasesWithAI(aiResult);
                
                // Show Insights
                showAIInsight('conversionInsight', aiResult.conversionComment);
                showAIInsight('hookInsight', aiResult.hookComment);
                showAIInsight('timingInsight', aiResult.timingComment);
                showAIInsight('scorecardInsight', aiResult.scorecardComment);
                showAIInsight('visibilityInsight', aiResult.visibilityInsight);
                showAIInsight('formatInsight', aiResult.formatInsight);
                showAIInsight('performanceInsight', aiResult.performanceInsight);

                // Re-render views with new data
                auditTiming(currentProcessedData);
                renderGlobalTags(); 
                const select = document.getElementById('languageSelect');
                if(select.value) renderNativeTags();

                alert("AI Analysis Complete! All sections updated.");

            } catch (error) {
                console.error("AI Error:", error);
                alert("AI Analysis failed. Please check API Key or try again.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function generateSpecificSuggestions() {
            const lang = document.getElementById('assistantLangSelect').value;
            const context = document.getElementById('assistantContext').value;
            const outputBox = document.getElementById('assistantOutput');
            const btn = document.getElementById('btnGenerateAssistant');

            if(!context) {
                alert("Please enter content details.");
                return;
            }

            const originalBtn = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Thinking...`;
            btn.disabled = true;

            const prompt = `
            Task: Generate 3 Viral, Neutral Islamic Titles and 15 Hashtags.
            Language/Account: ${lang}.
            Content Context: ${context}.
            
            Rules:
            1. Titles must be "Question-First" or "Negative Hook" style (e.g. "Don't do this...", "Why did Allah...?").
            2. Hashtags must be in native script mixed with English if applicable, STRICTLY neutral (No sectarian tags).
            3. Format as valid HTML (using <br> and <strong>).
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                outputBox.innerHTML = marked.parse(text);

            } catch(e) {
                console.error(e);
                outputBox.innerHTML = `<span class="text-red-400">Error generating suggestions. Try again.</span>`;
            } finally {
                btn.innerHTML = originalBtn;
                btn.disabled = false;
            }
        }

        function updateDatabasesWithAI(result) {
            if(result.bestTimes) bestTimesDB = { ...bestTimesDB, ...result.bestTimes };
            if(result.hashtags) {
                Object.keys(result.hashtags).forEach(lang => {
                    if (islamicHashtagsDB.instagram.native[lang]) {
                        islamicHashtagsDB.instagram.native[lang] = result.hashtags[lang];
                        islamicHashtagsDB.facebook.native[lang] = result.hashtags[lang];
                    }
                });
            }
        }

        function showAIInsight(elementId, text) {
            const el = document.getElementById(elementId);
            if(el && text) {
                el.querySelector('.ai-content').innerHTML = marked.parse(text);
                el.classList.remove('hidden');
            }
        }


        // --- 3. INITIALIZATION ---
        window.onload = function() {
            lucide.createIcons();
        };

        function loadDemoData() {
            processData(demoData);
        }

        function togglePlatform(platform) {
            currentPlatform = platform;
            
            const btnInsta = document.getElementById('btn-instagram');
            const btnFb = document.getElementById('btn-facebook');
            
            if (platform === 'instagram') {
                btnInsta.className = "px-4 py-2 rounded text-sm font-medium transition bg-pink-600 text-white shadow-lg";
                btnFb.className = "px-4 py-2 rounded text-sm font-medium transition text-gray-400 hover:text-white";
            } else {
                btnFb.className = "px-4 py-2 rounded text-sm font-medium transition bg-blue-600 text-white shadow-lg";
                btnInsta.className = "px-4 py-2 rounded text-sm font-medium transition text-gray-400 hover:text-white";
            }

            if (currentProcessedData.length > 0) {
                renderGlobalTags();
                renderNativeTags(); 
            }
        }

        function findValue(row, possibleHeaders) {
            const normalizedKeys = Object.keys(row).reduce((acc, key) => {
                const cleanKey = key.replace(/^\uFEFF/, '').trim().toLowerCase();
                acc[cleanKey] = key;
                return acc;
            }, {});

            for (const header of possibleHeaders) {
                const searchHeader = header.toLowerCase();
                const originalKey = normalizedKeys[searchHeader];
                
                if (originalKey) {
                    const val = row[originalKey];
                    if (val !== undefined && val !== null && val.toString().trim() !== "") {
                        return val;
                    }
                }
            }
            return null;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const mappedData = results.data.map(row => {
                        const nameHeaders = ['Language', 'Language Name', 'Username', 'Account', 'Page', 'Page Name', 'Profile', 'Name', 'Account Name'];
                        const reachHeaders = ['Reach', 'Views', 'Impressions', 'Lifetime Post Total Reach', 'Total Reach', 'Post reach', 'People Reached'];
                        const shareHeaders = ['Shares', 'Share Count', 'Total Shares', 'Post shares', 'Shares'];
                        const followHeaders = ['Follows', 'New Followers', 'Likes', 'New Likes', 'Page Likes', 'Total Follows', 'Followers'];
                        const unfollowHeaders = ['Unfollows', 'Lost Followers', 'Unlikes', 'Unlike Count'];
                        const typeHeaders = ['Type', 'Media Type', 'Format', 'Post Type'];
                        const likeHeaders = ['Likes', 'Post Likes', 'Reactions', 'Like Count']; 
                        const commentHeaders = ['Comments', 'Post comments', 'Comment Count', 'Replies'];
                        const timeHeaders = ['Posting Time', 'Time', 'Created', 'Date', 'Posted', 'Publish time', 'Posted at'];
                        const descHeaders = ['Description', 'Title', 'Caption', 'Post Message', 'Message', 'Text'];
                        const tagHeaders = ['Hashtags', 'Tags'];

                        return {
                            language: findValue(row, nameHeaders) || "Unknown",
                            reach: safeParse(findValue(row, reachHeaders)),
                            shares: safeParse(findValue(row, shareHeaders)),
                            follows: safeParse(findValue(row, followHeaders)),
                            unfollows: safeParse(findValue(row, unfollowHeaders)),
                            type: findValue(row, typeHeaders) || "Unknown",
                            likes: safeParse(findValue(row, likeHeaders) || findValue(row, followHeaders)), 
                            comments: safeParse(findValue(row, commentHeaders)),
                            postingTime: findValue(row, timeHeaders) || "12:00",
                            description: findValue(row, descHeaders) || "",
                            hasHashtags: (findValue(row, tagHeaders) || "").length > 0
                        };
                    });

                    const cleanData = mappedData.filter(d => d.language !== "Unknown" || d.reach > 0);
                    if (cleanData.length === 0) {
                        alert("Could not automatically map columns. Please check your CSV headers.");
                        return;
                    }
                    processData(cleanData);
                }
            });
        }

        // --- 4. DATA PROCESSING ---
        // IMPROVED: Strict priority check to separate Urdu-Hindi combined from individual accounts
        function normalizeLanguage(rawName) {
            if (!rawName) return "Unknown";
            const lower = rawName.toLowerCase();
            
            // Iterate through priority list to catch specific matches (like Urdu-Hindi) before general ones
            for (const entry of languageAliasesPriority) {
                if (entry.aliases.some(alias => lower.includes(alias.toLowerCase()))) {
                    return entry.canonical;
                }
            }
            return rawName.trim(); 
        }

        function processData(rawData) {
            currentRawData = rawData;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dashboardGrid').classList.remove('hidden');
            document.getElementById('aiTriggerBtn').classList.remove('hidden'); 

            let minDate = new Date(8640000000000000);
            let maxDate = new Date(-8640000000000000);
            let hasDates = false;

            const aggregated = {};
            rawData.forEach(row => {
                if(row.postingTime) {
                    const d = new Date(row.postingTime);
                    if(!isNaN(d)) {
                        if(d < minDate) minDate = d;
                        if(d > maxDate) maxDate = d;
                        hasDates = true;
                    }
                }

                const rawName = row.language ? row.language.trim() : "Unknown";
                const key = normalizeLanguage(rawName);
                
                if (!aggregated[key]) {
                    aggregated[key] = {
                        language: key,
                        reach: 0,
                        shares: 0,
                        follows: 0,
                        unfollows: 0,
                        postCount: 0,
                        postingTimes: [],
                        descriptions: []
                    };
                }
                aggregated[key].reach += row.reach;
                aggregated[key].shares += row.shares;
                aggregated[key].follows += row.follows;
                aggregated[key].unfollows += row.unfollows;
                aggregated[key].postCount += 1;
                aggregated[key].postingTimes.push(row.postingTime);
                aggregated[key].descriptions.push(row.description);
            });

            const auditEl = document.getElementById('auditPeriod');
            if(hasDates) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                auditEl.innerText = `Audit Period: ${minDate.toLocaleDateString(undefined, options)} - ${maxDate.toLocaleDateString(undefined, options)}`;
                auditEl.classList.remove('hidden');
            } else {
                 auditEl.innerText = "Audit Period: N/A";
                 auditEl.classList.remove('hidden');
            }

            const processedData = Object.values(aggregated);
            currentProcessedData = processedData; 
            
            processedData.forEach(lang => {
                 lang.postingTime = getMode(lang.postingTimes) || "12:00";
                 lang.description = lang.descriptions[0] || ""; 
            });

            processedData.sort((a, b) => b.reach - a.reach);

            if(processedData.length > 0) {
                 const topAccount = processedData[0].language;
                 document.getElementById('contentBridgeText').innerHTML = `
                 The #1 account (<span class="text-emerald-400 font-bold">${topAccount}</span>) is succeeding due to <strong>high-arousal emotional hooks</strong> and consistent timing.
                 `;
            }

            calculateHealthScore(processedData); 
            renderPerformanceChart(processedData);
            renderConversionTable(processedData);
            auditTiming(processedData); 
            renderRoadmap(processedData);
            populateLanguageDropdown(processedData);
            populateFormatDropdown(processedData);
            populateAssistantDropdown(processedData);
            renderGlobalTags();
            auditTitles(rawData); 
            renderVisibilityChart(processedData);
            renderFormatAnalysis(rawData);
        }

        function populateFormatDropdown(data) {
            const select = document.getElementById('formatAccountSelect');
            select.innerHTML = '<option value="all">All Accounts Aggregated</option>';
            data.sort((a,b) => a.language.localeCompare(b.language)).forEach(row => {
                const option = document.createElement('option');
                option.value = row.language;
                option.text = row.language;
                select.appendChild(option);
            });
        }
        
        function populateAssistantDropdown(data) {
            const select = document.getElementById('assistantLangSelect');
            const englishOpt = select.querySelector('option[value="English"]');
            select.innerHTML = ''; 
            if(englishOpt) select.appendChild(englishOpt);

            data.sort((a,b) => a.language.localeCompare(b.language)).forEach(row => {
                const option = document.createElement('option');
                option.value = row.language;
                option.text = row.language;
                select.appendChild(option);
            });
        }

        function renderFormatAnalysisFromGlobal() {
            const select = document.getElementById('formatAccountSelect');
            const selectedAccount = select.value;
            if (selectedAccount === 'all') {
                renderFormatAnalysis(currentRawData);
            } else {
                const filtered = currentRawData.filter(d => normalizeLanguage(d.language) === selectedAccount);
                renderFormatAnalysis(filtered);
            }
        }

        function renderFormatAnalysis(data) {
            const stats = {
                image: { likes: 0, shares: 0, comments: 0, count: 0 },
                carousel: { likes: 0, shares: 0, comments: 0, count: 0 },
                video: { likes: 0, shares: 0, comments: 0, count: 0 }
            };

            data.forEach(d => {
                const t = (d.type || "").toLowerCase();
                let bucket = 'image';
                if (t.includes('reel') || t.includes('video') || t.includes('short') || t.includes('mp4')) bucket = 'video';
                else if (t.includes('carousel') || t.includes('album') || t.includes('sidecar')) bucket = 'carousel';
                else if (t.includes('photo') || t.includes('image') || t.includes('img')) bucket = 'image';
                
                stats[bucket].likes += (d.likes || 0);
                stats[bucket].shares += (d.shares || 0);
                stats[bucket].comments += (d.comments || 0);
                stats[bucket].count++;
            });

            const fmt = (num) => num.toLocaleString();
            document.getElementById('imgLikes').innerText = fmt(stats.image.likes);
            document.getElementById('imgShares').innerText = fmt(stats.image.shares);
            document.getElementById('imgComments').innerText = fmt(stats.image.comments);
            document.getElementById('carLikes').innerText = fmt(stats.carousel.likes);
            document.getElementById('carShares').innerText = fmt(stats.carousel.shares);
            document.getElementById('carComments').innerText = fmt(stats.carousel.comments);
            document.getElementById('vidLikes').innerText = fmt(stats.video.likes);
            document.getElementById('vidShares').innerText = fmt(stats.video.shares);
            document.getElementById('vidComments').innerText = fmt(stats.video.comments);
        }

        function calculateHealthScore(data) {
            if(data.length === 0) return;
            let totalReach = 0, totalShares = 0, totalConv = 0;
            data.forEach(d => {
                totalReach += d.reach;
                totalShares += d.shares;
                totalConv += d.follows;
            });

            const avgShareRate = totalReach > 0 ? (totalShares / totalReach) * 100 : 0;
            const avgConvRate = totalReach > 0 ? (totalConv / totalReach) * 1000 : 0;

            let score = 0;
            if(avgShareRate > 1.5) score += 40; else if(avgShareRate > 0.8) score += 30; else score += 10;
            if(avgConvRate > 8) score += 40; else if(avgConvRate > 4) score += 30; else score += 10;
            if(data.length > 5) score += 20;

            let grade = 'C';
            let color = 'text-gray-500 border-gray-600';
            if(score >= 85) { grade = 'A+'; color = 'text-emerald-400 border-emerald-500 shadow-[0_0_15px_rgba(52,211,153,0.5)]'; }
            else if(score >= 70) { grade = 'A'; color = 'text-emerald-300 border-emerald-500'; }
            else if(score >= 50) { grade = 'B'; color = 'text-blue-400 border-blue-500'; }
            else if(score >= 30) { grade = 'C'; color = 'text-yellow-400 border-yellow-500'; }
            else { grade = 'D'; color = 'text-red-400 border-red-500'; }

            const gradeEl = document.getElementById('healthGradeCircle');
            gradeEl.innerText = grade;
            gradeEl.className = `grade-circle mx-auto ${color} bg-gray-800`;
            document.getElementById('scoreShare').innerText = avgShareRate.toFixed(2) + '%';
            document.getElementById('scoreConv').innerText = avgConvRate.toFixed(1);
            document.getElementById('scoreTop').innerText = data[0].language;
            document.getElementById('scoreCount').innerText = currentRawData.length;
        }

        function getMode(array) {
            if(array.length == 0) return null;
            var modeMap = {};
            var maxEl = array[0], maxCount = 1;
            for(var i = 0; i < array.length; i++) {
                var el = array[i];
                if (!el) continue;
                try {
                   if(el.includes(':')) el = el.split(':')[0] + ":00";
                } catch(e){}
                if(modeMap[el] == null) modeMap[el] = 1;
                else modeMap[el]++;  
                if(modeMap[el] > maxCount) {
                    maxEl = el;
                    maxCount = modeMap[el];
                }
            }
            return maxEl;
        }

        function renderPerformanceChart(data) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = data.map(d => d.language);
            const reachData = data.map(d => d.reach);
            const shareRates = data.map(d => d.reach > 0 ? ((d.shares / d.reach) * 100).toFixed(2) : 0);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Reach',
                            data: reachData,
                            backgroundColor: '#3b82f6',
                            yAxisID: 'y',
                            borderRadius: 4
                        },
                        {
                            label: 'Share Rate (%)',
                            data: shareRates,
                            type: 'line',
                            borderColor: '#34d399',
                            borderWidth: 2,
                            pointBackgroundColor: '#10b981',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        y: { type: 'linear', display: true, position: 'left', ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#34d399' } }
                    }
                }
            });
        }

        function renderVisibilityChart(data) {
            let totalReach = 0, totalFollows = 0, totalUnfollows = 0;
            data.forEach(d => {
                totalReach += d.reach;
                totalFollows += d.follows;
                totalUnfollows += (d.unfollows || 0);
            });

            document.getElementById('totalReachDisplay').innerText = totalReach.toLocaleString();
            document.getElementById('totalFollowsDisplay').innerText = "+" + totalFollows.toLocaleString();
            document.getElementById('totalUnfollowsDisplay').innerText = totalUnfollows === 0 ? "0" : "-" + totalUnfollows.toLocaleString();

            const ctx = document.getElementById('visibilityChart').getContext('2d');
            if (visibilityChartInstance) visibilityChartInstance.destroy();

            let chartLabels = [], chartValues = [];
            if (data.length > 5) {
                const sorted = [...data].sort((a,b) => b.reach - a.reach);
                const top5 = sorted.slice(0, 5);
                const others = sorted.slice(5);
                const othersReach = others.reduce((acc, curr) => acc + curr.reach, 0);
                chartLabels = top5.map(d => d.language);
                chartValues = top5.map(d => d.reach);
                chartLabels.push('Others');
                chartValues.push(othersReach);
            } else {
                chartLabels = data.map(d => d.language);
                chartValues = data.map(d => d.reach);
            }

            visibilityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartValues,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 10 } } } },
                    cutout: '70%'
                }
            });
        }

        function renderConversionTable(data) {
            const tbody = document.getElementById('conversionTableBody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const conversionScore = row.reach > 0 ? ((row.follows / row.reach) * 1000).toFixed(1) : 0;
                let badgeClass = 'badge-yellow', statusText = 'Avg';
                if (conversionScore > 8) { badgeClass = 'badge-green'; statusText = 'Elite'; }
                if (conversionScore < 3) { badgeClass = 'badge-red'; statusText = 'Poor'; }
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-700 hover:bg-gray-800 transition";
                tr.innerHTML = `
                    <td class="py-2 text-gray-300 font-medium break-words">${row.language}</td>
                    <td class="py-2 text-right font-mono text-blue-300">${conversionScore}</td>
                    <td class="py-2 text-right"><span class="${badgeClass}">${statusText}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderGlobalTags() {
            const globalContainer = document.getElementById('globalTagsContainer');
            globalContainer.innerHTML = '';
            const db = islamicHashtagsDB[currentPlatform];
            db.global.forEach(tag => {
                const span = document.createElement('span');
                span.className = "text-xs bg-gray-800 text-blue-200 px-2 py-1 rounded border border-blue-900/30 cursor-pointer hover:bg-blue-900 transition";
                span.innerText = tag;
                span.onclick = () => copySingleTag(span);
                globalContainer.appendChild(span);
            });
        }

        function populateLanguageDropdown(data) {
            const select = document.getElementById('languageSelect');
            select.innerHTML = '<option value="">Select Account</option>';
            const sortedData = [...data].sort((a, b) => a.language.localeCompare(b.language));
            sortedData.forEach(row => {
                const option = document.createElement('option');
                option.value = row.language; 
                option.text = row.language;
                select.appendChild(option);
            });
        }

        function renderNativeTags() {
            const select = document.getElementById('languageSelect');
            const container = document.getElementById('nativeTagsContainer');
            const selectedAccount = select.value;
            container.innerHTML = '';
            if (!selectedAccount) {
                container.innerHTML = '<div class="text-gray-500 text-xs text-center italic mt-4">Select an account to view specific Islamic hashtags.</div>';
                return;
            }

            const db = islamicHashtagsDB[currentPlatform];
            const tags = db.native[selectedAccount];
            if (tags) {
                const wrapper = document.createElement('div');
                let tagsHtml = tags.map(t => `<span class="inline-block text-xs text-emerald-200 bg-emerald-900/30 px-1.5 py-0.5 rounded mr-1 mb-1 hover:bg-emerald-800 cursor-pointer" onclick="copySingleTag(this)">${t}</span>`).join('');
                wrapper.innerHTML = `
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2 flex justify-between">
                        <span>${selectedAccount} Tags</span>
                        <div class="flex items-center gap-2">
                             <span class="text-[10px] text-gray-500">Click icon to copy all</span>
                             <i data-lucide="copy" class="w-4 h-4 cursor-pointer text-gray-400 hover:text-white" onclick="copyGroup(this, '${tags.join(' ')}')"></i>
                        </div>
                    </div>
                    <div class="flex flex-wrap">${tagsHtml}</div>
                `;
                container.appendChild(wrapper);
                lucide.createIcons();
            } else {
                 container.innerHTML = `<div class="text-yellow-500 text-xs text-center mt-4">No specific tags available for "${selectedAccount}".</div>`;
            }
        }

        function copySingleTag(element) {
            navigator.clipboard.writeText(element.innerText).then(() => {
                const originalBg = element.style.backgroundColor;
                element.style.backgroundColor = "#059669";
                setTimeout(() => element.style.backgroundColor = originalBg, 400);
            });
        }

        function copyGroup(icon, text) {
            navigator.clipboard.writeText(text).then(() => {
                icon.classList.remove('text-gray-400'); icon.classList.add('text-green-400');
                setTimeout(() => { icon.classList.remove('text-green-400'); icon.classList.add('text-gray-400'); }, 1000);
            });
        }

        function auditTiming(data) {
            const container = document.getElementById('timingContainer');
            container.innerHTML = '';
            if (data.length === 0) return;
            data.forEach(row => {
                let istanbulHour = 12; 
                try { istanbulHour = parseInt(row.postingTime.split(':')[0]); } catch(e) {}
                let offset = 0; 
                let langKey = Object.keys(timezoneOffsets).find(k => row.language.toLowerCase().includes(k.toLowerCase()));
                if (langKey) offset = timezoneOffsets[langKey];
                let currentNativeHour = istanbulHour + offset;
                if (currentNativeHour >= 24) currentNativeHour -= 24;
                if (currentNativeHour < 0) currentNativeHour += 24;
                let bestNativeHour = bestTimesDB[row.language] || 18;
                const isGood = Math.abs(currentNativeHour - bestNativeHour) <= 1;
                let recommendedIstanbul = bestNativeHour - offset;
                if (recommendedIstanbul >= 24) recommendedIstanbul -= 24;
                if (recommendedIstanbul < 0) recommendedIstanbul += 24;
                const formatTime = (h) => `${Math.floor(h).toString().padStart(2,'0')}:00`;

                const card = document.createElement('div');
                card.className = `p-3 rounded border flex flex-col gap-2 ${isGood ? 'bg-emerald-900/10 border-emerald-900/50' : 'bg-red-900/10 border-red-900/50'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-sm text-gray-200 break-words max-w-[200px]">${row.language}</div>
                            <div class="text-xs text-gray-500 mt-1">Avg Post: ${formatTime(istanbulHour)} (IST) ‚Üí <span class="text-blue-300">${formatTime(currentNativeHour)} (Local)</span></div>
                        </div>
                        <div class="${isGood ? 'text-emerald-400' : 'text-red-400'} text-xs font-bold text-right">${isGood ? 'Optimal' : 'Adjust'}</div>
                    </div>
                    ${!isGood ? `
                    <div class="mt-1 pt-2 border-t border-gray-700/50 flex justify-between items-center bg-gray-900/30 p-2 rounded">
                        <div class="text-[10px] text-gray-400">Local "Golden Hour": <span class="text-white font-bold">${formatTime(bestNativeHour)}</span></div>
                        <div class="text-right"><span class="block text-gray-500 text-[10px] uppercase">Post at (IST):</span><span class="block text-indigo-400 font-bold font-mono text-sm">${formatTime(recommendedIstanbul)}</span></div>
                    </div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function auditTitles(rawData) {
            let strong = 0, weak = 0;
            const weakRegex = /^(update|video|upload|new|daily|post|img)/i;
            const strongRegex = /(\?|!|secret|stop|truth|why|how|top \d|amazing|best)/i;
            rawData.forEach(row => {
                if(!row.description || row.description.length < 5 || weakRegex.test(row.description)) weak++;
                else if (strongRegex.test(row.description)) strong++;
                else weak++;
            });
            document.getElementById('strongHooksCount').innerText = strong;
            document.getElementById('weakHooksCount').innerText = weak;
        }

        function renderRoadmap(data) {
            const container = document.getElementById('fixesContainer');
            container.innerHTML = '';
            data.slice(0, 20).forEach(row => {
                let fix = specificFixesDB[row.language] || (row.reach > 0 && (row.shares / row.reach) < 0.005 ? "Low share rate. Use high-arousal hooks." : "Healthy metrics. Scale volume.");
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-3 rounded border-l-4 border-blue-500";
                div.innerHTML = `<span class="font-bold text-xs text-blue-300 uppercase break-words">${row.language}</span><p class="text-sm text-gray-300 mt-1">${fix}</p>`;
                container.appendChild(div);
            });
        }

        function copyText(element) {
            navigator.clipboard.writeText(element.innerText).then(() => {
                const original = element.style.borderColor; element.style.borderColor = "#34d399";
                setTimeout(() => element.style.borderColor = "#374151", 500);
            });
        }
    </script>
</body>
</html>
